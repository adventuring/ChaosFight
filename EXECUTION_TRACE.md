# Execution Flow Trace - ColdStart to Publisher Prelude

## Step-by-Step Execution Flow

### Phase 1: Reset Handler (BankSwitching.s, every bank)
1. Reset vector at $FFFC points to `.Reset` at $FFF0
2. `.Reset` handler:
   - `nop $ffed` - switches to Bank 14 (0-based index 13)
   - `jmp ColdStart` - direct jump (no return address)

### Phase 2: ColdStart (Bank 14)
1. Console detection (inline, no gosub)
2. Startup.s included:
   - Clears RAM (TIA, zero page, SCRAM)
   - Initializes stack (SP = $FF)
   - Initializes registers
3. `gosub InitializeSpritePointers bank14` - same bank gosub
4. Set TIA color registers
5. `let gameMode = ModePublisherPrelude` (0)
6. `gosub ChangeGameMode bank14` - same bank gosub
   - Calls `SetupPublisherPrelude`
   - Calls `BeginPublisherPrelude` (sets preambleTimer = 0)
   - Returns to ColdStart
7. `goto MainLoop bank16` - **CROSS-BANK GOTO**
   - Compiles to: push MainLoop-1, set X=15, jmp BS_jsr
   - BS_jsr switches to Bank 16, then RTS to MainLoop

### Phase 3: MainLoop (Bank 16)
1. `let frame = frame + 1`
2. `if switchreset then gosub WarmStart bank13`
3. `on gameMode gosub MainLoopModePublisherPrelude ...`
   - Pushes return address `ongosub0-1` on stack
   - Loads target address from jump table (MainLoopModePublisherPrelude)
   - RTS to jump to MainLoopModePublisherPrelude

### Phase 4: MainLoopModePublisherPrelude (Bank 16)
1. `gosub PublisherPreludeMain bank14` - cross-bank gosub
   - Uses BS_jsr mechanism
   - Pushes return address (to MainLoopModePublisherPrelude)
   - Switches to Bank 14
   - Jumps to PublisherPreludeMain

### Phase 5: PublisherPreludeMain (Bank 14)
1. Check button inputs
2. `gosub PlayMusic bank15`
3. Check auto-advance condition
4. `let preambleTimer = preambleTimer + 1`
5. `gosub SetPublisherWindowValues bank14`
6. `return otherbank` - should use BS_return
   - BS_return extracts bank from return address
   - Switches back to Bank 16
   - Returns to MainLoopModePublisherPrelude

### Phase 6: Return to MainLoopModePublisherPrelude (Bank 16)
1. `return` - normal return (same bank)
   - Should return to `ongosub0` (after jump tables)

### Phase 7: Continue in MainLoop (Bank 16)
1. Execution continues at `ongosub0` label
2. Falls through to `MainLoopContinue`
3. Audio update logic
4. `MainLoopDrawScreen`
5. `goto MainLoop bank16` - loops back

## Potential Issues

1. **goto MainLoop bank16**: Uses BS_jsr but doesn't push a return address first
   - BS_jsr expects: [target address] on stack
   - goto pushes: MainLoop-1 on stack
   - BS_jsr does: switch bank, RTS (which pops MainLoop-1 and jumps there)
   - This should work, but there's no return path

2. **on gameMode gosub return**: Returns to `ongosub0` which is generated by batariBASIC
   - `ongosub0` should be after the jump tables
   - Jump tables are after the `on gameMode gosub` statement
   - Mode handler labels are right after the statement
   - So `ongosub0` should be after the mode handler labels

3. **Cross-bank return path**: 
   - PublisherPreludeMain does `return otherbank`
   - Should return to MainLoopModePublisherPrelude
   - MainLoopModePublisherPrelude does `return`
   - Should return to `ongosub0`

## Questions to Investigate

1. Does `goto MainLoop bank16` properly switch banks?
2. Does `on gameMode gosub` properly set up return address?
3. Does `return otherbank` properly restore bank and return address?
4. Is `ongosub0` label in the right place?
5. Does execution fall through after `on gameMode gosub`?

