          rem ChaosFight - Source/Routines/MainLoop.bas
          rem Copyright Â© 2025 Bruce-Robert Pocock.

MainLoop
          asm
MainLoop
end
          rem Dispatches game modes and handles reset entry point
          rem Inputs: switchreset (hardware), gameMode (global 0-7)
          rem Outputs: Dispatches to mode-specific handlers
          rem Mutates: None; dispatcher only
          rem Calls: WarmStart bank13, PublisherPreludeMain bank14, AuthorPrelude bank14,
          rem        TitleScreenMain bank14, CharacterSelectInputEntry bank9,
          rem        FallingAnimation1 bank11, ArenaSelect1 bank14,
          rem        GameMainLoop bank11, WinnerAnnouncementLoop bank12,
          rem        PlayMusic bank1, titledrawscreen bank9
          rem Constraints: Must remain colocated with MainLoopDrawScreen

          rem Entry point for entire game loop
          rem Increment frame counter (used for frame budgeting and timing)
          let frame = frame + 1
          if switchreset then gosub WarmStart bank13
          ; fall through to continue

          rem Optimized: Use on/gosub for space efficiency
          rem on gameMode gosub uses RTS to jump to target, returns to ongosub0 (generated by batariBASIC)
          on gameMode gosub MainLoopModePublisherPrelude MainLoopModeAuthorPrelude MainLoopModeTitleScreen MainLoopModeCharacterSelect MainLoopModeFallingAnimation MainLoopModeArenaSelect MainLoopModeGameMain MainLoopModeWinnerAnnouncement
          ; Execution continues at ongosub0 label (generated by batariBASIC after jump tables)
          ; Mode handlers return here after completing

MainLoopModePublisherPrelude
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          rem The far-called routines (PublisherPreludeMain, etc.) handle their own return otherbank
          gosub PublisherPreludeMain bank14
          return thisbank
MainLoopModeAuthorPrelude
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub AuthorPrelude bank14
          return thisbank
MainLoopModeTitleScreen
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub TitleScreenMain bank14
          return thisbank
MainLoopModeCharacterSelect
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub CharacterSelectInputEntry bank9
          return thisbank
MainLoopModeFallingAnimation
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub FallingAnimation1 bank11
          return thisbank
MainLoopModeArenaSelect
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub ArenaSelect1 bank14
          return thisbank
MainLoopModeGameMain
          rem CRITICAL: Guard against being called when not in game mode
          rem This prevents crashes when gameMode is corrupted or incorrectly set
          rem Only call GameMainLoop when actually in game mode (ModeGame = 6)
          if gameMode = ModeGame then goto MainLoopModeGameMainContinue
          return thisbank
MainLoopModeGameMainContinue
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub GameMainLoop bank11
          return thisbank
MainLoopModeWinnerAnnouncement
          rem CRITICAL: on gameMode gosub is a near call (pushes 2-byte return address)
          rem Must use return thisbank to match the near call, not return otherbank
          gosub WinnerAnnouncementLoop bank12
          return thisbank
MainLoopContinue
          rem Routes audio updates after per-mode execution
          rem Inputs: gameMode (global 0-7)
          rem Outputs: Falls through to MainLoopDrawScreen
          rem Mutates: None; dispatcher only
          rem Calls: PlayMusic bank1 (for modes < 3 and mode 7); colocated with MainLoop/MainLoopDrawScreen
          rem Notes: Modes 3-6 handle audio updates in their own routines

          rem Check if music update is needed for game modes < 3 or mode 7
          if gameMode < 3 then gosub PlayMusic bank15
          if gameMode = 7 then gosub PlayMusic bank15
SkipMusicUpdate
MainLoopDrawScreen
          rem Renders the appropriate screen for the current game mode
          rem Inputs: gameMode (global 0-7)
          rem Outputs: Screen rendered via titledrawscreen or drawscreen
          rem Mutates: TIA registers, playfield, sprite state
          rem Calls: titledrawscreen bank9 (title screens); colocated with MainLoop
          rem Notes: Modes 3-6 funnel through mode-specific draw logic

          rem Titlescreen graphics and kernel reside in bank9
          if gameMode < 3 then gosub DrawTitleScreen bank9
          if gameMode >= 3 then drawscreen
          goto MainLoop bank16
